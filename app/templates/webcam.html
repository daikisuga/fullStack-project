{% extends "base.html" %}

{% block title %}üé• Webcam{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <h2 class="mb-4 text-center">Visualiza√ß√£o da Webcam</h2>
        <div class="col-md-12 text-center">
            <video id="webcam" autoplay playsinline width="480" height="360" style="border: 2px solid #ccc; border-radius: 8px;"></video>
            <canvas id="canvas" width="480" height="360" style="display: none;"></canvas>
            <p class="mt-3">Ajuste seu posicionamento e ilumina√ß√£o antes de iniciar.<br>Certifique-se de que o ambiente est√° bem iluminado e que voc√™ esteja no meio da c√¢mera.</p>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');

    async function startWebcam() {
        // Verifica se o navegador suporta a API getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Seu navegador n√£o suporta acesso √† webcam via getUserMedia.");
            return;
        }

        try {
            // Solicita o stream da webcam
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
        } catch (err) {
            alert("Erro ao acessar a webcam: " + err.message);
        }
    }

    async function captureFrame() {
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = canvas.toDataURL('image/jpeg');

        await fetch('/upload_frame', {
            method: 'POST',
            headers: {
                'Content-type' : 'application/json',
            },
            body: JSON.stringify({image: imgData})
        })
    }
    // Envia o frame a cada 10 segundos
    setInterval(captureFrame, 1000);

    // Inicia a webcam assim que o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', startWebcam);
</script>
{% endblock %}
