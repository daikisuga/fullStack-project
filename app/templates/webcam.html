{% extends "base.html" %}

{% block title %}Webcam - Captura de Emo√ß√µes{% endblock %}

{% block content %}
<<<<<<< Updated upstream
<div class="container py-4">
    <div class="row">
        <h2 class="mb-4 text-center">Visualiza√ß√£o da Webcam</h2>
        <div class="col-md-12 text-center">
            <video id="webcam" autoplay playsinline width="480" height="360" style="border: 2px solid #ccc; border-radius: 8px;"></video>
            <canvas id="canvas" width="480" height="360" style="display: none;"></canvas>
            <p class="mt-3">Ajuste seu posicionamento e ilumina√ß√£o antes de iniciar.<br>Certifique-se de que o ambiente est√° bem iluminado e que voc√™ esteja no meio da c√¢mera.</p>
        </div>
    </div>
=======
<h2>üé• Captura de Emo√ß√µes via Webcam</h2>
<div id="webcam-container">
    <video id="webcam" autoplay playsinline width="480" height="360" style="border: 2px solid #ccc; border-radius: 8px;"></video>
    <canvas id="canvas" width="480" height="360" style="display:none;"></canvas>
    <div id="emotion-result" style="margin-top:20px;"></div>
    <button id="start-btn" class="btn btn-primary">Iniciar Captura</button>
    <button id="stop-btn" class="btn btn-danger" style="display:none;">Parar</button>
>>>>>>> Stashed changes
</div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
<<<<<<< Updated upstream
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
=======
let capturing = false;
let intervalId;
const video = document.getElementById('webcam');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const emotionResult = document.getElementById('emotion-result');
>>>>>>> Stashed changes

async function setupWebcam() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
}

startBtn.onclick = async function() {
    capturing = true;
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    emotionResult.innerHTML = 'Capturando emo√ß√µes...';
    await faceapi.nets.tinyFaceDetector.loadFromUri('/static/models');
    await faceapi.nets.faceExpressionNet.loadFromUri('/static/models');
    intervalId = setInterval(async () => {
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
        if (detections.length > 0) {
            const emotions = detections[0].expressions;
            const sorted = Object.entries(emotions).sort((a,b) => b[1]-a[1]);
            emotionResult.innerHTML = `Emo√ß√£o detectada: <b>${sorted[0][0]}</b> (${(sorted[0][1]*100).toFixed(1)}%)`;
            // Aqui voc√™ pode enviar para o backend via fetch/AJAX se quiser salvar o dataset
        } else {
            emotionResult.innerHTML = 'Nenhum rosto detectado.';
        }
    }, 1000);
};

stopBtn.onclick = function() {
    capturing = false;
    startBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';
    clearInterval(intervalId);
    emotionResult.innerHTML = 'Captura finalizada.';
};

<<<<<<< Updated upstream
    async function captureFrame() {
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = canvas.toDataURL('image/jpeg');

        await fetch('/upload_frame', {
            method: 'POST',
            headers: {
                'Content-type' : 'application/json',
            },
            body: JSON.stringify({image: imgData})
        })
    }
    // Envia o frame a cada 10 segundos
    setInterval(captureFrame, 1000);

    // Inicia a webcam assim que o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', startWebcam);
=======
setupWebcam();
>>>>>>> Stashed changes
</script>
{% endblock %}
